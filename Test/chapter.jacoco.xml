<?xml version="1.0" encoding="UTF-8"?>
<chapter id="JaCoCo">
	<title>JaCoCo - Java code coverage tool</title>
	<section id="jacoco.maven">
		<title>Maven</title>
		<screen>
		<![CDATA[
mvn help:describe -Dplugin=org.jacoco:jacoco-maven-plugin -Ddetail		
		]]>
		</screen>
		<screen>
		<![CDATA[
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>

	<groupId>demo</groupId>
	<artifactId>junit4</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<packaging>jar</packaging>

	<name>junit4</name>
	<url>http://maven.apache.org</url>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	</properties>

	<dependencies>
		<dependency>
			<groupId>junit</groupId>
			<artifactId>junit</artifactId>
			<version>4.11</version>
			<scope>test</scope>
		</dependency>
	</dependencies>
	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-surefire-plugin</artifactId>
				<version>2.22.1</version>
				<configuration>
					<useSystemClassLoader>false</useSystemClassLoader>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.jacoco</groupId>
				<artifactId>jacoco-maven-plugin</artifactId>
				<version>0.8.2</version>
				<executions>
					<execution>
						<goals>
							<goal>prepare-agent</goal>
						</goals>
					</execution>
					<execution>
						<id>report</id>
						<phase>test</phase>
						<goals>
							<goal>report</goal>
						</goals>
					</execution>
				</executions>

			</plugin>
		</plugins>
	</build>
	<reporting>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-surefire-report-plugin</artifactId>
				<version>2.22.1</version>
			</plugin>
		</plugins>
	</reporting>
</project>
		
		]]>
		</screen>
		<para>运行 mvn test 便会生成 jacoco 报告</para>
		<screen>
		<![CDATA[
neo@MacBook-Pro ~/workspace/junit4 % find target/site/jacoco 
target/site/jacoco
target/site/jacoco/jacoco.csv
target/site/jacoco/demo.junit4
target/site/jacoco/demo.junit4/index.source.html
target/site/jacoco/demo.junit4/index.html
target/site/jacoco/demo.junit4/App.java.html
target/site/jacoco/demo.junit4/App.html
target/site/jacoco/index.html
target/site/jacoco/jacoco-sessions.html
target/site/jacoco/jacoco-resources
target/site/jacoco/jacoco-resources/branchnc.gif
target/site/jacoco/jacoco-resources/sort.js
target/site/jacoco/jacoco-resources/greenbar.gif
target/site/jacoco/jacoco-resources/sort.gif
target/site/jacoco/jacoco-resources/source.gif
target/site/jacoco/jacoco-resources/report.gif
target/site/jacoco/jacoco-resources/prettify.js
target/site/jacoco/jacoco-resources/branchpc.gif
target/site/jacoco/jacoco-resources/branchfc.gif
target/site/jacoco/jacoco-resources/class.gif
target/site/jacoco/jacoco-resources/prettify.css
target/site/jacoco/jacoco-resources/report.css
target/site/jacoco/jacoco-resources/group.gif
target/site/jacoco/jacoco-resources/package.gif
target/site/jacoco/jacoco-resources/redbar.gif
target/site/jacoco/jacoco-resources/up.gif
target/site/jacoco/jacoco-resources/session.gif
target/site/jacoco/jacoco-resources/down.gif
target/site/jacoco/jacoco-resources/method.gif
target/site/jacoco/jacoco-resources/bundle.gif
target/site/jacoco/jacoco.xml

		]]>
		</screen>
	</section>
	<section id="jacoco.gradle">
		<title>Gradle</title>
		<para>https://docs.gradle.org/current/userguide/jacoco_plugin.html</para>
		<para>plugins 中加入 id 'jacoco'</para>
		<screen>
		<![CDATA[
/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java Library project to get you started.
 * For more details take a look at the Java Libraries chapter in the Gradle
 * user guide available at https://docs.gradle.org/5.0/userguide/java_library_plugin.html
 */

plugins {
    // Apply the java-library plugin to add support for Java Library
    id 'java-library'
    // id 'java'
    id 'eclipse' // optional (to generate Eclipse project files)
	id 'idea' // optional (to generate IntelliJ IDEA project files)
	id 'jacoco'
}

repositories {
    // Use jcenter for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
    jcenter()
    //mavenCentral()
}

dependencies {
    
    testCompile('org.junit.jupiter:junit-jupiter-api:5.3.2')
	testCompile('org.junit.jupiter:junit-jupiter-params:5.3.2')
	testRuntime('org.junit.jupiter:junit-jupiter-engine:5.3.2')
	
	testCompile 'io.rest-assured:rest-assured:3.2.0'
	testCompile 'io.rest-assured:json-schema-validator:3.2.0'
	compile 'io.rest-assured:rest-assured:3.2.0'
	compile 'io.rest-assured:json-path:3.2.0'
	compile 'io.rest-assured:xml-path:3.2.0'
	
}

test {
	useJUnitPlatform()
	testLogging {
		events "passed", "skipped", "failed"
	}
}		
		]]>
		</screen>
		<para>运行 gradlew build jacocoTestReport 生成测试报告</para>
		<screen>
		<![CDATA[
neo@MacBook-Pro ~/workspace/junit5 % ./gradlew build jacocoTestReport

BUILD SUCCESSFUL in 5s
6 actionable tasks: 2 executed, 4 up-to-date
neo@MacBook-Pro ~/workspace/junit5 % find build/reports/jacoco
build/reports/jacoco
build/reports/jacoco/test
build/reports/jacoco/test/html
build/reports/jacoco/test/html/index.html
build/reports/jacoco/test/html/jacoco-sessions.html
build/reports/jacoco/test/html/jacoco-resources
build/reports/jacoco/test/html/jacoco-resources/branchnc.gif
build/reports/jacoco/test/html/jacoco-resources/sort.js
build/reports/jacoco/test/html/jacoco-resources/greenbar.gif
build/reports/jacoco/test/html/jacoco-resources/sort.gif
build/reports/jacoco/test/html/jacoco-resources/source.gif
build/reports/jacoco/test/html/jacoco-resources/report.gif
build/reports/jacoco/test/html/jacoco-resources/prettify.js
build/reports/jacoco/test/html/jacoco-resources/branchpc.gif
build/reports/jacoco/test/html/jacoco-resources/branchfc.gif
build/reports/jacoco/test/html/jacoco-resources/class.gif
build/reports/jacoco/test/html/jacoco-resources/prettify.css
build/reports/jacoco/test/html/jacoco-resources/report.css
build/reports/jacoco/test/html/jacoco-resources/group.gif
build/reports/jacoco/test/html/jacoco-resources/package.gif
build/reports/jacoco/test/html/jacoco-resources/redbar.gif
build/reports/jacoco/test/html/jacoco-resources/up.gif
build/reports/jacoco/test/html/jacoco-resources/session.gif
build/reports/jacoco/test/html/jacoco-resources/down.gif
build/reports/jacoco/test/html/jacoco-resources/method.gif
build/reports/jacoco/test/html/jacoco-resources/bundle.gif
build/reports/jacoco/test/html/net.coding.api.task
build/reports/jacoco/test/html/net.coding.api.task/Task.java.html
build/reports/jacoco/test/html/net.coding.api.task/index.source.html
build/reports/jacoco/test/html/net.coding.api.task/index.html
build/reports/jacoco/test/html/net.coding.api.task/Task.html
build/reports/jacoco/test/html/junit5
build/reports/jacoco/test/html/junit5/Library.java.html
build/reports/jacoco/test/html/junit5/index.source.html
build/reports/jacoco/test/html/junit5/index.html
build/reports/jacoco/test/html/junit5/UnitTest.java.html
build/reports/jacoco/test/html/junit5/Library.html
build/reports/jacoco/test/html/junit5/UnitTest.html
build/reports/jacoco/test/html/junit5/Config.html
build/reports/jacoco/test/html/junit5/Config.java.html
build/reports/jacoco/test/html/com.example.project
build/reports/jacoco/test/html/com.example.project/index.source.html
build/reports/jacoco/test/html/com.example.project/index.html
build/reports/jacoco/test/html/com.example.project/Calculator.java.html
build/reports/jacoco/test/html/com.example.project/Calculator.html
		]]>
		</screen>
		<para>如果你希望自动执行，不需要携带 jacocoTestReport 任务，添加下面代码到 build.gradle 文件最下面 </para>
		<screen>
		<![CDATA[
test.finalizedBy(project.tasks.jacocoTestReport)		
		]]>
		</screen>
		<para>排除 class </para>
		<screen>
		<![CDATA[
jacocoTestReport {
  afterEvaluate {
    classDirectories = files(classDirectories.files.collect {
      fileTree(dir: it, exclude: [
        'io/reflectoring/coverage/ignored/**',
        'io/reflectoring/coverage/part/**'
      ])
    })
  }
}		
		]]>
		</screen>
	</section>
	<section>
		<title>Skipping JaCoCo execution due to missing execution data file.</title>
		<screen>
		<![CDATA[
[INFO] --- jacoco-maven-plugin:0.8.7:report (report) @ eureka ---
[INFO] Skipping JaCoCo execution due to missing execution data file.		
		]]>
		</screen>
		<para>问题处在 maven-surefire-plugin 跳过了测试</para>
		<screen>
		<![CDATA[
[INFO] --- maven-surefire-plugin:2.22.2:test (default-test) @ eureka ---
[INFO] Tests are skipped.
[INFO] 
		]]>
		</screen>
		<para>解决方案，在 pom.xml 中添加如下配置</para>
		<screen>
		<![CDATA[
			<plugin>
				<artifactId>maven-surefire-plugin</artifactId>
				<configuration>
					<skip>false</skip>
				</configuration>
			</plugin>
		]]>
		</screen>
		<para>再次运行 mvn test 可以看到结果</para>
		<screen>
		<![CDATA[
[INFO] ------------------------< cn.netkiller:config >-------------------------
[INFO] Building config 0.0.1-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- jacoco-maven-plugin:0.8.7:prepare-agent (default) @ config ---
[INFO] argLine set to -javaagent:/Users/neo/.m2/repository/org/jacoco/org.jacoco.agent/0.8.7/org.jacoco.agent-0.8.7-runtime.jar=destfile=/Users/neo/workspace/microservice/config/target/jacoco.exec
[INFO] 
[INFO] --- maven-resources-plugin:3.2.0:resources (default-resources) @ config ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] Using 'UTF-8' encoding to copy filtered properties files.
[INFO] Copying 1 resource
[INFO] Copying 6 resources
[INFO] 
[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ config ---
[INFO] Nothing to compile - all classes are up to date
[INFO] 
[INFO] --- maven-resources-plugin:3.2.0:testResources (default-testResources) @ config ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] Using 'UTF-8' encoding to copy filtered properties files.
[INFO] Copying 1 resource
[INFO] 
[INFO] --- maven-compiler-plugin:3.8.1:testCompile (default-testCompile) @ config ---
[INFO] Nothing to compile - all classes are up to date
[INFO] 
[INFO] --- maven-surefire-plugin:2.22.2:test (default-test) @ config ---
[INFO] 
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] 
[INFO] Results:
[INFO] 
[INFO] Tests run: 0, Failures: 0, Errors: 0, Skipped: 0
[INFO] 
[INFO] 
[INFO] --- jacoco-maven-plugin:0.8.7:report (report) @ config ---
[INFO] Loading execution data file /Users/neo/workspace/microservice/config/target/jacoco.exec
[INFO] Analyzed bundle 'config' with 1 classes
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  3.335 s
[INFO] Finished at: 2021-10-22T15:52:36+08:00
[INFO] ------------------------------------------------------------------------		
		]]>
		</screen>
	</section>
</chapter>
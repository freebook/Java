<?xml version="1.0" encoding="UTF-8"?>
<chapter id="index"><?dbhtml dir="mvc" ?>
	<title>Spring MVC</title>
	<para>Spring MVC 有两种启动模式，一种是传统Tomcat，需要配置很多XML文件。另一种方式是采用 Spring Boot 需要些一个Java程序，不需要写xml文件，这个程序会帮助你处理启动所需的一切，并且采用嵌入方式启动 Tomcat 或者 Jetty.</para>
	<para>两种方式各有优缺点，Tomcat 方式配置繁琐，但是可以使用虚拟机，同一个IP地址使用不同域名访问，出现不同的内容。而Spring Boot一个应用一个容器一个端口，比不得不通过端口来区分应用。</para>

	<section id="@EnableWebMvc">
		<title>@EnableWebMvc</title>
		<programlisting>
		<![CDATA[
package cn.netkiller.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.DefaultServletHandlerConfigurer;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;
import org.springframework.web.servlet.view.InternalResourceViewResolver;

@Configuration
@EnableWebMvc
public class WebMvcConfig extends WebMvcConfigurerAdapter {

	@Override
	public void configureDefaultServletHandling(DefaultServletHandlerConfigurer configurer) {
		configurer.enable();
	}

	@Bean
	public InternalResourceViewResolver viewResolver() {
		InternalResourceViewResolver resolver = new InternalResourceViewResolver();
		resolver.setPrefix("WEB-INF/jsp/");
		resolver.setSuffix(".jsp");
		return resolver;
	}

}
		]]>
		</programlisting>
		<section id="cors">
			<title>CORS 跨域请求</title>
			<programlisting>
			<![CDATA[
@Configuration
public class CorsConfiguration
{
    @Bean
    public WebMvcConfigurer corsConfigurer()
    {
        return new WebMvcConfigurerAdapter() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**");
            }
        };
    }
}		
			]]>
			</programlisting>
			<programlisting>
			<![CDATA[
 	@Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurerAdapter() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**").allowedOrigins("*");
            }
        };
    }			
			]]>
			</programlisting>
		</section>
		<section>
			<title>Spring MVC CORS with WebMvcConfigurerAdapter</title>
			<programlisting>
			<![CDATA[
@Configuration
@EnableWebMvc
public class CorsConfiguration extends WebMvcConfigurerAdapter
{
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**").allowedMethods("GET", "POST");
    }
}
			]]>
			</programlisting>
			<programlisting>
			<![CDATA[
@Configuration
@EnableWebMvc
public class AppConfig extends WebMvcConfigurerAdapter {
	@Override
	public void addCorsMappings(CorsRegistry registry) {
	  registry.addMapping("/info/**")
	   	  .allowedOrigins("http://localhost:8080", "http://localhost:8000")
		  .allowedMethods("POST", "GET",  "PUT", "OPTIONS", "DELETE")
		  .allowedHeaders("X-Auth-Token", "Content-Type")
		  .exposedHeaders("custom-header1", "custom-header2")
		  .allowCredentials(false)
		  .maxAge(4800);
	}
}			
			]]>
			</programlisting>
		</section>

	</section>
	
	&section.mvc.controller.xml;	
	&section.mvc.view.xml;
	&section.mvc.service.xml;
	<section id="spring.mvc.i18n">
		<title>i18n 国际化</title>
		<section>
			<title>在 appliction.properties 中配置启用 i18n</title>
			<screen>
			<![CDATA[
spring.messages.basename=message
spring.messages.encoding=UTF-8
			]]>
			</screen>
		</section>
		<section>
			<title>创建语言包文件</title>
			<para>创建默认语言包文件 message.properties，当匹配不到语言时使用默认配置</para>
			<screen>
			<![CDATA[
member.name=Name
			]]>
			</screen>
			<para>message_en_US.properties</para>
			<screen>
			<![CDATA[
member.name=Name
			]]>
			</screen>
			<para>message_zh_CN.properties</para>
			<screen>
			<![CDATA[
member.name=姓名
			]]>
			</screen>
			<para>注意：Eclipse 需要安装 properties 编辑工具，否则中文会自动转换成UTF8编码，无法直接阅读。</para>
		</section>
		<section>
			<title>控制器重引用语言包</title>
			<para>RestController</para>
			<programlisting>
			<![CDATA[
@RestController
public class HomeController {
	@Autowired
	private MessageSource messageSource;

	@GetMapping("/lang")
	public String language() {
		String message = messageSource.getMessage("member.name", null, LocaleContextHolder.getLocale());
		return message;
	}
}
			]]>
			</programlisting>
			<para>Controller</para>
			<programlisting>
			<![CDATA[
package cn.netkiller.controller;

import org.springframework.stereotype.Controller;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.MessageSource;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.ui.Model;
import java.util.Locale;

@Controller
public class HomeController {

    @Autowired
    private MessageSource messageSource;

    @RequestMapping(value = "/", method = RequestMethod.GET)
    public String index(Locale locale, Model model){

        // add parametrized message from controller
        String welcome = messageSource.getMessage("welcome.message", new Object[]{"Neo Chan"}, locale);
        model.addAttribute("message", welcome);
        
        // obtain locale from LocaleContextHolder
        Locale currentLocale = LocaleContextHolder.getLocale();
        model.addAttribute("locale", currentLocale);
        model.addAttribute("startMeeting", "10:30");
        
        return "index";
    }

}			
			]]>
			</programlisting>
		</section>
		<section>
			<title>参数传递</title>
			<para>有时定义语言包会出现一种情况，一个句子中可能存在变量。例如：</para>
			<para>恭喜你 XXXX 您已成为我们的会员</para>
			<para>这样的需求，如果丁一两个key处理起来会非常麻烦。这里可以定义一个变量，通过参数传递来修改一句话中间的部分。</para>
			<screen>
			<![CDATA[
welcome=Welcom to {0}
			]]>
			</screen>
			<screen>
			<![CDATA[
	@GetMapping("/lang/args")
	public String welcome() {
		String[] args = { "China" };
		String message = messageSource.getMessage("welcome", args, LocaleContextHolder.getLocale());

		return message;
	}
			]]>
			</screen>
			<para>参数以此类推 {0}, {1} ...... {n}</para>
			<screen>
			<![CDATA[
String welcome = messageSource.getMessage("welcome.message", new Object[]{"Neo chen"}, locale);			
			]]>
			</screen>
		</section>
	</section>
	&section.mvc.validation.xml;
	&section.mvc.interceptor.xml;
	&section.mvc.faq.xml;
</chapter>